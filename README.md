# Блокировки
В РФ ввели интернет-цензуру, в связи с этим провайдеров обязали устанавливать "чёрные ящики"
"Ящики" называются ТСПУ, что значит "Технические Средства Противодействия Угрозам".

## ТСПУ
ТСПУ является комплексом средств для блокировки. Одним из них является DPI, который можно обойти с помощью ByeDPI.

# Обход блокировок по DPI (атака DPI, десинхронизация и прочие синонимы)
Целью атаки является сделать начало соединения (TLS Handshake - TLS Рукопожатие) незаметным для ТСПУ и установить безопасное соединение (HTTPS) с сайтом

<details><summary>О TLS Handshake (упрощённная версия статьи из Википедии) </summary>
  Как устанавливается безопасное соединение (на примере TLS 1.2)
  
  1. Начало договора:
  Наш клиент (допустим, браузер) посылает TLS Record (TLS Запись, в неё входит информация о клиенте) ClientHello (в переводе: Привет от Клиента), в котором указанны: версия TLS-протокола, которую поддерживает клиент, случайные данные и список поддерживаемых методов шифрования (cipher suites), подходящих для работы с TLS.
  
  2. Обработка запроса сервером
     
  Сервер даёт ServerHello (Привет от сервера), содержащим: выбранную сервером версию TLS, случайное число, сгенерированное сервером, выбранный метод шифрования из тех, что дал клиент

  2.1. Сервер отправляет свой цифровой сертификат сервера (в зависимости от версии TLS этот этап может быть пропущен)
  
 3. Если клиенту мало данных для шифрования
    
  Если переданных сервером данных мало, то сервер передаёт сообщение ServerKeyExchange, в котором передаются необходимые данные, которые затребовал клиент.

 3.1. Сервер отсылает ServerHelloDone, означающее конец первого раунда установления соединения
    
 3.2 Клиент даёт ClientKeyExchange, которое содержит клиентскую часть протокола Диффи-Хеллмана или зашифрованный открытым ключом из сертификата сервера (PreMasterSecret).
    
 3.3. Клиент и сервер, используя ключ PreMasterSecret и случайно сгенерированные числа, вычисляют общий секрет. Вся остальная информация о сеансовом ключе будет получена из общего секрета.
    
 3.4. Клиент посылает ChangeCipherSpec, которое указывает на то, что вся последующая информация будет зашифрована в процессе подтверждения связи алгоритмом, используя общий секретный ключ.
    
 4. Последний этап
    
 4.1. Клиент посылает Finished, которое содержит данные, сгенерированные на основе предыдущих сообщений процедуры подтверждения связи.
 
 4.2. Сервер пытается расшифровать Finished-сообщение клиента и проверить эти данные. Если процесс расшифровки или проверки не удаётся - соединение должно быть оборвано.
 
 4.3. Сервер посылает ChangeCipherSpec и зашифрованный Finished (клиент тоже проверит всё).

 5. Соединение установленно (в обычных условиях соединение может занять до 3-5 секунд)
 
</details>

<details><summary>Содержание TLS Record (TLS Запись) для ClientHello </summary>
  
Состоит из байтов, которые принимают различные значения
  
Смещение байтов - положение ячейки(!)
  
Счёт смещения начинается с нуля(!)
  
0 байт - Тип содержания (принимает значения от 0x14 по 0x17)

1 и 2 байт - версия TLS (0x03 - мажорная версия TLS, 0x0n - минорная версия TLS (вместо n нужное Вам значение))

3-4 байт - Длина (Leght) TLS Record (значения с 0x00 0x00 по 0x40 0x00, максимальное колличиство: 16.384 байта)

5-36 байты - Random (информация из установленного времени и случайных значений)

37 байт - длина ID сессии (Session ID, индетификатор сессии)

38-? байты - ID сессии (может быть изпользован для востановления соединения)
</details>

<details><summary>Значения 0 байта в TLS Record </summary>
  Значения:
  
    * 0x14 — Change Cipher Spec
    
    * 0x15 — Alert. (Сообщения об ошибках или уведомление о закрытии соединения)
    
    * 0x16 — Handshake. (Сообщения для установки соединения).
    
    * 0x17 — Application Data. (Данные, которые уже зашифрованы).
    
</details>


## Виды атак, их описания и немного теории
Атаки могут быть разных видов.
* В ByeDPI их несколько:
  * Split - нарезка
  * Disoder - обратная отправка
  * OOB - (Out-Of-Band - Вне очереди) имеет пометку, как срочный
  * OOB Disoder - обратная отправка с пометкой "срочный"
  * FAKE - является disoder'ом с подмешиванием сгенерированных пакетов в поток)
  * UDP Fake - сгенерировать UDP пакет

  ### Что такое UDP и TCP?
  Это протоколы (правила общения между Вами и сайтом)
  * TCP (Подходит для сайтов)
    * Имеет гарантии доставки и целостности данных, переотправляя потерянные пакеты при обнаружении пропажи
    * Защищает данные за счёт SSL (протокол, предназначенный для защиты соединений) шифрования с помощью TLS
    * Имеет более низкии скорости, чем UDP из-за установки безопасного соединения

  * UDP (Подходит для медия или звонков)
    * Высокая скорость
    * Отсутствие шифрования (хотя для UDP можно изпользовать DTLS - аналог TLS для UDP)

 # Как атаковать DPI?

 Если DPI сверяет определённые элементы TLS Record на предмет не разрешённого трафика и если находит его, то он генерирует TCP пакет RST (мгновенный сброс соединения) или FIN (мягкое закрытие содинения).
 
   ### Стратегии
   Это набор аргументов (структура аргумента: "-", "нужный вам
   
  ## Атака в действии
 За пример возмём стратегию -o2 -d3. Разберём её.
Порядок отправки: 1-3 (при OOB берётся доп. байт байт 
 Первые 2 пакета помечаются как "срочные" (в некоторых ситуациях оно может помочь с обходом или ухудшить ситуацию.
 1,2 нас уже отмечены как OOB, а 3 останется не тронутым. По
